# pdf2dcm_study

## Synopsis
A simple bash wrapper script for 
[pdf2dcm](https://support.dcmtk.org/docs/pdf2dcm.html), developed by DCMTK, 
to enhance it's study-from functionality. It reads a PDF file, converts it to 
a DICOM Encapsulated PDF Storage SOP instance and stores the converted data in 
an output file. Patient and study attributes are read from a reference DICOM
file.

## Usage
```bash
pdf2dcm_study [-h] [--no-color] pdf_in dcm_ref dcm_out doc_title series_num 
```
- `pdf_in`: PDF input filename to be encapsulated
- `dcm_ref`: read patient and study attributes from this reference DICOM file
- `dcm_out`: DICOM output filename
- `doc_title`: PDF document title used in DocumentTitle, ProtocolName and SeriesDescription attributes
- `series_num`: series number for DICOM output (e.g. 3000)

## Options
- `-h, --help`: print help and exit
- `--no-color`: don't colorize terminal output

## Description
A simple bash wrapper script for 
[pdf2dcm](https://support.dcmtk.org/docs/pdf2dcm.html), developed by DCMTK, 
to enhance it's "study-from" functionality. It reads a PDF file, converts it to 
a DICOM Encapsulated PDF Storage SOP instance and stores the converted data in 
an output file. Patient and study attributes are read from a reference DICOM
file.

The script was written because, even with the `--study-from` option set, 
`pdf2dcm` does NOT set the values of some attributes such as 
StudyDate and StudyTime etc..., as expected, from the attribute values in 
`dcm_ref`.

Each series is made up of one, or more, Encapsulated PDF Storage SOP Class 
instances. These  all have the same Study Instance and Series Instance UIDs 
but different SOP Instance UIDs (one for each instance within the series).

The PDF IOD, DICOM PS 3.3 Information Object Definition, contains the 
following Information Entities (IE) which themselves contain mandatory 
modules and attributes as shown below:

| Information Entity    | Module                         | Attribute Name                 | Source of Attribute Value|
|-----------------------|--------------------------------|--------------------------------|--------------------------|
| Patient               | Patient                        | PatientName                    | Copied from `dcm_ref` by `pdf2dcm` with `--study-from` option|
|                       |                                | PatientID                      | Copied from `dcm_ref` by `pdf2dcm` with `--study-from` option |
|                       |                                | IssuerOfPatientID              | Copied from `dcm_ref` using `dcmdump` |
|                       |                                | PatientBirthDate               | Copied from `dcm_ref` by `pdf2dcm` with `--study-from` option |
|                       |                                | PatientSex                     | Copied from `dcm_ref` by `pdf2dcm` with `--study-from` option |
| Study                 | General Study                  | StudyDate                      | Copied from `dcm_ref` using `dcmdump` |
|                       |                                | StudyTime                      | Copied from `dcm_ref` using `dcmdump` |
|                       |                                | AccessionNumber                | Copied from `dcm_ref` using `dcmdump` |
|                       |                                | ReferringPhysicianName         | Copied from `dcm_ref` using `dcmdump` |
|                       |                                | StudyDescription               | Copied from `dcm_ref` using `dcmdump` |
|                       |                                | StudyInstanceUID               | Copied from `dcm_ref` by `pdf2dcm` with `--study-from` option  |
|                       |                                | StudyID                        | Copied from `dcm_ref` using `dcmdump` |
|                       | Patient Study                  | PatientAge                     | Copied from `dcm_ref` using `dcmdump` |
|                       |                                | PatientWeight                  | Copied from `dcm_ref` using `dcmdump` |
| Series                | Encapsulated Document Series   | Modality                       | Set to "DOC" by `pdf2dcm`|
|                       |                                | SeriesDescription              | Set to same value as DocumentTitle |
|                       |                                | ProtocolName                   | Set to same value as DocumentTitle |
|                       |                                | SeriesInstanceUID              | Generated by `pdf2dcm` |
|                       |                                | SeriesNumber                   | Set by user via required argument to script |
| Equipment             | General Equipment              | Manufacturer                   | Set to "OFFIS_DCMTK" |
|                       |                                | InstitutionName                | Copied from `dcm_ref` using `dcmdump` |
|                       |                                | InstitutionAddress             | Copied from `dcm_ref` using `dcmdump`  |
|                       |                                | StationName                    | Set to "PDF_Generator"  |
|                       |                                | ManufacturerModelName          | Set to "OFFIS_DCMTK"  |
|                       | SC Equipment                   | ConversionType                 | Set to "WSD" by `pdf2dcm` |
| Encapsulated Document | Encapsulated Document          | ContentDate                    | Set to current date using `printf`|
|                       |                                | AcquisitionDateTime            | Set to current date/time using `printf`|
|                       |                                | ContentTime                    | Set to current time using `printf` |
|                       |                                | InstanceNumber                 | Set to "1" by pdf2dcm |
|                       |                                | BurnedInAnnotation             | Set to "YES" by `pdf2dcm` |
|                       |                                | ConceptNameCodeSequence        | Set to an empty sequence by `pdf2dcm` |
|                       |                                | DocumentTitle                  | Set by user via required argument to script and using the `--title` option to `pdf2dcm` |
|                       |                                | EncapsulatedDocument           | Set by `pdf2dcm` by converting supplied PDF to byte stream |
|                       |                                | MIMETypeOfEncapsulatedDocument | Set to "application/pdf" by `pdf2dcm` |
|                       | SOP Common                     | SpecificCharacterSet           | Set to "ISO_IR 100" by `pdf2dm`|
|                       |                                | InstanceCreationDate           | Set to current date by `pdf2dcm`| 
|                       |                                | InstanceCreationTime           | Set to current time by `pdf2dcm`| 
|                       |                                | SOPClassUID                    | Set to "EncapsulatedPDFStorage" by `pdf2dcm`| 
|                       |                                | SOPInstanceUID                 | Generated by `pdf2dcm`| 

>[!NOTE]
> Whilst not part of the DICOM Encapsulated PDF IOD the attributes SeriesDate 
> and SeriesTime were included and set to the date and time of `dcm_out` file 
> generation using `printf`.

>[!TIP]
> The IssuerOfPatientID tag is set using the environment variable 
> PDF2DCM_ISSUEROFPATIENTID_ENV. If this is not set "AAA" is used by default. 
> PDF2DCM_ISSUEROFPATIENTID_ENV can be set in your .bashrc file with 
> `export PDF2DCM_ISSUEROFPATIENTID_ENV="MY_ISSUER"`

>[!TIP]
> In the [NHS](https://www.nhs.uk/) the 
> [Organisation Data Service](https://digital.nhs.uk/services/organisation-data-service) 
> controls the Organisation Codes used to populate the IssuerOfPatientID tag. 
> These are publicly available via the 
>[ODS Portal](https://odsportal.digital.nhs.uk/Organisation/Search).

### DICOM Conformance Check
Test output DICOM files have been checked against the requirements of IODs and 
Modules defined in DICOM PS 3.3 Information Object Definition using 
[dicom3tools](http://dclunie.com/dicom3tools.html) `dciodvfy` and  `dcentvfy` 
written by David Clunie. 

## Software Requirements
- [bash](https://www.gnu.org/software/bash/)
- [DCMTK - DICOM Toolkit](https://dicom.offis.de/en/dcmtk/)

## License
See [MIT license](./LICENSE)

## Author
Written by [Stephen Wastling](mailto:stephen.wastling@nhs.net) 

## Acknowledgements
With many thanks to the developers of [bash](https://www.gnu.org/software/bash/) 
and the [DCMTK - DICOM Toolkit](https://dicom.offis.de/en/dcmtk/).

The script was based on a 
[template](https://betterdev.blog/minimal-safe-bash-script-template/) written 
by Maciej Radzikowski. 

The bash syntax was analysed and checked for bugs using 
[ShellCheck](https://www.shellcheck.net/) written by Vidar Holen. 

## References
1. [NEMA PS3 / ISO 12052, Digital Imaging and Communications in Medicine 
(DICOM) Standard, National Electrical Manufacturers Association, Rosslyn, 
VA, USA](http://medical.nema.org/) 
